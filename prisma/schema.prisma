// =============================================================================
// SCHÉMA PRISMA – Application RASF v2
// Restaurant Administratif de Saint-Pierre
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// ÉNUMÉRATIONS
// =============================================================================

// Rôles utilisateurs (§3 du CDC)
enum Role {
  AGENT
  GESTIONNAIRE
  ADMIN
}

// Statut du compte utilisateur (§4.1)
enum AccountStatus {
  PENDING   // En attente d'activation
  ACTIVE    // Compte actif
  DISABLED  // Compte désactivé
}

// Mode de consommation (§5.3)
enum ConsumptionMode {
  SUR_PLACE
  A_EMPORTER
}

// Type de plat pour les options du menu
enum CourseType {
  STARTER   // Entrée
  MAIN      // Plat principal
  DESSERT   // Dessert
}

// Statut de la réservation (suivi opérationnel §6.4)
enum ReservationStatus {
  BOOKED    // Réservé (par défaut)
  SERVED    // Repas servi
  NO_SHOW   // Agent non venu
}

// Type d'action pour l'audit (§11 RGPD)
enum AuditAction {
  RESERVATION_CREATED
  RESERVATION_MODIFIED
  RESERVATION_CANCELLED
  RESERVATION_SERVED
  RESERVATION_NO_SHOW
  ACCOUNT_CREATED
  ACCOUNT_ACTIVATED
  ACCOUNT_DISABLED
  MENU_CREATED
  MENU_MODIFIED
  MENU_DELETED
}

// =============================================================================
// UTILISATEURS (§3, §4)
// =============================================================================

model User {
  id                   String        @id @default(cuid())
  email                String        @unique
  firstName            String
  lastName             String
  passwordHash         String?       // Null si compte en attente d'activation
  canteenAccountNumber String?       @unique // Numéro de compte cantine (§4.1)
  role                 Role          @default(AGENT)
  status               AccountStatus @default(PENDING)

  // Token d'activation (§4.2 Option A)
  activationToken      String?       @unique
  activationExpires    DateTime?

  // Token reset mot de passe (§5.1)
  resetToken           String?       @unique
  resetTokenExpires    DateTime?

  // Métadonnées
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  lastLoginAt          DateTime?

  // Relations
  reservations         Reservation[]
  auditLogs            AuditLog[]    @relation("AuditUser")
  auditLogsPerformed   AuditLog[]    @relation("AuditPerformedBy")

  @@index([email])
  @@index([canteenAccountNumber])
  @@index([status])
}

// =============================================================================
// MENUS (§6.1)
// =============================================================================

// Menu du jour - conteneur pour les options
model Menu {
  id          String       @id @default(cuid())
  date        DateTime     @db.Date @unique // Un menu par jour

  // Informations générales du jour (optionnel)
  sideDishes  String?      // Accompagnements communs (riz, grains, légumes…)
  notes       String?      // Notes particulières du jour

  isPublished Boolean      @default(false) // Visible par les agents

  // Métadonnées
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  options     MenuOption[]

  @@index([date])
  @@index([isPublished])
}

// Options du menu (entrées, plats principaux, desserts)
model MenuOption {
  id          String     @id @default(cuid())
  menuId      String
  menu        Menu       @relation(fields: [menuId], references: [id], onDelete: Cascade)

  courseType  CourseType // STARTER, MAIN, DESSERT
  name        String     // Ex: "Salade de crudités", "Poulet rôti", "Tarte aux fruits"
  description String?    // Détails supplémentaires
  maxCapacity Int?       // Capacité max optionnelle pour cette option
  sortOrder   Int        @default(0) // Ordre d'affichage dans sa catégorie

  // Métadonnées
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations vers Reservation (selon le type)
  reservationsAsStarter Reservation[] @relation("StarterOption")
  reservationsAsMain    Reservation[] @relation("MainOption")
  reservationsAsDessert Reservation[] @relation("DessertOption")

  @@index([menuId])
  @@index([courseType])
  @@index([menuId, courseType])
}

// =============================================================================
// RÉSERVATIONS (§5.3, §5.4, §6.2)
// =============================================================================

model Reservation {
  id              String            @id @default(cuid())

  // Agent
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Date de la réservation
  date            DateTime          @db.Date

  // Choix de l'agent
  // Entrée choisie (optionnel si une seule entrée)
  starterOptionId String?
  starterOption   MenuOption?       @relation("StarterOption", fields: [starterOptionId], references: [id], onDelete: SetNull)

  // Plat principal choisi (obligatoire) - Restrict pour empêcher suppression si utilisé
  mainOptionId    String
  mainOption      MenuOption        @relation("MainOption", fields: [mainOptionId], references: [id], onDelete: Restrict)

  // Dessert choisi (optionnel si un seul dessert)
  dessertOptionId String?
  dessertOption   MenuOption?       @relation("DessertOption", fields: [dessertOptionId], references: [id], onDelete: SetNull)

  consumptionMode ConsumptionMode   // Sur place ou à emporter (obligatoire)

  // Suivi opérationnel (§6.4)
  status          ReservationStatus @default(BOOKED)

  // Métadonnées
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Une seule réservation par agent par jour
  @@unique([userId, date])
  @@index([date])
  @@index([userId])
  @@index([status])
  @@index([mainOptionId])
}

// =============================================================================
// PARAMÈTRES GLOBAUX (§7)
// =============================================================================

model Settings {
  id                         String   @id @default("global")

  // Heure limite de réservation (§8.1) - Format "HH:MM"
  reservationDeadline        String   @default("10:00")

  // Jours d'ouverture (§7) - Array de 0-6 (0=Dimanche, 1=Lundi...)
  openDays                   Int[]    @default([1, 2, 3, 4, 5])

  // Nombre de semaines visibles pour réservation (§5.2, §8.2)
  weeksInAdvance             Int      @default(2)

  // Capacité maximale globale par jour (§8.3) - null = illimité
  maxDailyCapacity           Int?

  // Notifications activées (§7)
  notificationsEnabled       Boolean  @default(false)

  // Suivi opérationnel activé (§6.4)
  operationalTrackingEnabled Boolean  @default(true)

  // Métadonnées
  updatedAt                  DateTime @updatedAt
}

// =============================================================================
// AUDIT / TRAÇABILITÉ (§2.3, §11 RGPD)
// =============================================================================

model AuditLog {
  id            String      @id @default(cuid())

  // Utilisateur concerné par l'action
  userId        String?
  user          User?       @relation("AuditUser", fields: [userId], references: [id], onDelete: SetNull)

  // Utilisateur ayant effectué l'action
  performedById String?
  performedBy   User?       @relation("AuditPerformedBy", fields: [performedById], references: [id], onDelete: SetNull)

  action        AuditAction
  entityType    String?     // Ex: "Reservation", "Menu", "User"
  entityId      String?     // ID de l'entité concernée
  details       Json?       // Détails supplémentaires
  ipAddress     String?

  createdAt     DateTime    @default(now())

  @@index([userId])
  @@index([performedById])
  @@index([action])
  @@index([createdAt])
}
